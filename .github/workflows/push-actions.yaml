name: push-actions
on: [push]
jobs:
  check-files:
    name: "Check Files"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: pip install -r deploy/docker/development-server/hook-requirements.txt
      - run: isort --check-only .
      - run: black --check --diff .
      - run: flake8 --config setup.cfg .
      - run: mypy .
      - run: find . -type f -name *.sh | xargs shellcheck
  run-djang-tests-in-k8s:
    name: "Tests in K8s"
    runs-on: ubuntu-latest
    steps:
      - uses: balchua/microk8s-actions@v0.1.3
        with:
          channel: 'latest/stable'
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install charts
        run: ./dev.sh start
  run-django-tests:
    name: "Django tests"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13.2
        env:
          POSTGRES_USER: postgresadmin
          POSTGRES_PASSWORD: postgrespwd
          POSTGRES_DB: appdb
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
         python-version: 3.9
      - name: Install dependencies
        run: pip install -r deploy/docker/development-server/requirements.txt
      - name: Run tests
        working-directory: ./server
        run: python manage.py test


